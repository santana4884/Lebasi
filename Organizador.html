<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Pedidos</title>
    <!-- Fontes do Google (do seu app antigo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Todo o seu CSS customizado do app antigo foi colado aqui -->
    <style>
        :root {
            --cor-fundo: #f4f7fd;
            --cor-cartao-fundo: #ffffff;
            --cor-texto-primaria: #172b4d;
            --cor-texto-secundaria: #5e6c84;
            --cor-sombra: rgba(23, 43, 77, 0.1);
            --cor-borda: #dfe1e6;
            --cor-azul-principal: #ff6400; /* Cor laranja principal */
            --cor-azul-hover: #fd864f; /* Cor laranja hover */
            --espacamento: 16px;
            --raio-borda: 8px;
        }

        body.dark-mode {
            --cor-fundo: #0d1117;
            --cor-cartao-fundo: #21262d;
            --cor-texto-primaria: #c9d1d9;
            --cor-texto-secundaria: #8b949e;
            --cor-sombra: rgba(0, 0, 0, 0.2);
            --cor-borda: #30363d;
            --cor-azul-principal: #ff6400;
            --cor-azul-hover: #fd864f;
        }

        html { height: 100%; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-primaria);
            margin: 0;
            height: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
            padding: var(--espacamento);
        }
        .container-principal {
            max-width: 1200px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--espacamento);
            flex-shrink: 0;
        }
        .header-esquerda {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        h1 { font-size: 1.8rem; margin: 0; }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cor-azul-principal); }
        input:checked + .slider:before { transform: translateX(20px); }
        nav { display: flex; gap: 12px; }
        .nav-link {
            text-decoration: none;
            color: var(--cor-texto-primaria);
            background-color: var(--cor-cartao-fundo);
            padding: 8px 16px;
            border-radius: var(--raio-borda);
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px var(--cor-sombra);
        }
        .nav-link:hover {
            background-color: var(--cor-azul-principal);
            color: white;
        }
        .organizador-container {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--espacamento);
            background-color: var(--cor-cartao-fundo);
            padding: var(--espacamento);
            border-radius: var(--raio-borda);
            box-shadow: 0 4px 8px var(--cor-sombra);
            min-height: 0;
        }
        .painel { display: flex; flex-direction: column; }
        .painel h2 { margin-top: 0; border-bottom: 2px solid var(--cor-borda); padding-bottom: 8px; }
        
        /* Aumentamos a altura mínima do textarea para preencher a tela */
        textarea {
            width: 100%;
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--cor-borda);
            border-radius: var(--raio-borda);
            font-family: monospace;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-primaria);
            resize: none;
            min-height: 250px; /* Altura mínima para preenchimento */
        }
        
        .actions-container {
            display: flex;
            gap: 12px;
            margin-top: var(--espacamento);
        }
        .btn-acao {
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: var(--raio-borda);
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            flex-grow: 1;
        }
        /* Corrigindo ID do botão para combinar com o estilo laranja */
        #btn-organizar { background-color: var(--cor-azul-principal); }
        #btn-organizar:hover:not(:disabled) { background-color: var(--cor-azul-hover); }
        #btn-organizar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #btn-criar-kanban {
            background-color: #00875A; /* Verde */
            opacity: 0.5;
            cursor: not-allowed;
        }
        #btn-criar-kanban:not(:disabled):hover { background-color: #006644; }
        #btn-criar-kanban:not(:disabled) {
            opacity: 1;
            cursor: pointer;
        }
        
        .resultado-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .btn-copiar {
             background-color: var(--cor-texto-secundaria);
             color: white;
             border: none;
             padding: 8px 12px;
             font-size: 0.9rem;
             font-weight: 500;
             border-radius: var(--raio-borda);
             cursor: pointer;
             transition: background-color 0.2s ease;
             min-width: 80px; /* Largura mínima */
             text-align: center;
        }
        .btn-copiar:hover { background-color: var(--cor-texto-primaria); }
        
        /* Novo estilo para mensagem de erro */
        #error-message {
            color: var(--cor-azul-principal); /* Laranja para destaque */
            font-weight: 500;
            margin-top: 10px;
            height: 20px; /* Altura fixa para não empurrar o layout */
        }

        @media (max-width: 768px) {
            body { height: auto; }
            .organizador-container { grid-template-columns: 1fr; height: auto; }
            textarea { min-height: 150px; }
        }
    </style>
</head>
<body>
    <!-- Estrutura HTML do seu app antigo -->
    <div class="container-principal">
        <header>
            <div class="header-esquerda">
                <h1>Organizador de Pedidos</h1>
                 <div class="theme-switch-wrapper">
                      <label class="theme-switch" for="checkbox">
                           <input type="checkbox" id="checkbox" />
                           <div class="slider round"></div>
                      </label>
                 </div>
            </div>
            <nav>
                <!-- Link para o Kanban (do seu app antigo) -->
                <a href="index.html" class="nav-link">Ir para o Kanban</a>
            </nav>
        </header>

        <div class="organizador-container">
            <div class="painel">
                <h2>1. Cole a lista do cliente aqui</h2>
                <!-- ID "input-lista" mantido para corresponder ao seu app antigo -->
                <textarea id="input-lista" placeholder="Ex: Nome:will Numero:08 Tamanho:M&#10;ana // 16 // M&#10;Carlos-10-G&#10;..."></textarea>
                <div class="actions-container">
                    <!-- ID "btn-organizar" mantido -->
                    <button class="btn-acao" id="btn-organizar">Organizar com IA</button>
                    <!-- Botão do Kanban (do seu app antigo) -->
                    <button class="btn-acao" id="btn-criar-kanban" disabled>Criar Pedido no Kanban</button>
                </div>
                <!-- Local para exibir mensagens de erro -->
                <div id="error-message"></div>
            </div>
            <div class="painel" style="overflow-y: auto;">
                <h2>2. Copie os resultados</h2>

                <!-- Bloco Power Duplicate (do seu app antigo) -->
                <div class="resultado-actions">
                    <label for="output-powerduplicate">Formato Certo</label>
                    <button class="btn-copiar" id="btn-copiar-powerduplicate">Copiar</button>
                </div>
                <textarea id="output-powerduplicate" readonly></textarea>

                <!-- Bloco Nomes (do seu app antigo) -->
                <div class="resultado-actions" style="margin-top: 16px;">
                    <label for="output-nomes">Nomes (Separados)</label>
                    <button class="btn-copiar" id="btn-copiar-nomes">Copiar</button>
                </div>
                <textarea id="output-nomes" readonly></textarea>

                <!-- Bloco Números (do seu app antigo) -->
                 <div class="resultado-actions" style="margin-top: 16px;">
                    <label for="output-numeros">Números (Separados)</label>
                    <button class="btn-copiar" id="btn-copiar-numeros">Copiar</button>
                </div>
                <textarea id="output-numeros" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- Script principal (mistura do antigo e do novo) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURAÇÃO DA API (NOVO) ---
        const apiKey = "AIzaSyDWu4utTwOsadcG-4T051-Uh7L5RdGcQgc"; // Lembre-se de colar sua API key aqui para rodar local
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // O "cérebro" da IA (NOVO)
        const SYSTEM_PROMPT = `
            Você é um assistente de organização de pedidos de camisas.
            Sua única tarefa é extrair o NOME, NÚMERO e TAMANHO de cada linha de texto fornecida pelo usuário.
            REGRAS DE FORMATAÇÃO DA SAÍDA:
            1.  Formate CADA pedido *exclusivamente* no formato: NOME NÚMERO TAMANHO.
            2.  Não adicione absolutamente nada extra: sem cabeçalhos, sem markdown, sem marcadores, sem "Aqui está sua lista:".
            3.  Retorne apenas a lista formatada, com um pedido por linha.
            4.  Se uma linha for impossível de interpretar (ex: "cliente ligou"), retorne essa linha como [ERRO DE FORMATO].
            5.  Padronize o tamanho para uma única letra maiúscula (ex: 'm' vira 'M', 'Pequeno' vira 'P').
        `;

        // --- ELEMENTOS DO DOM (ANTIGO + NOVO) ---
        const btnOrganizar = document.getElementById('btn-organizar');
        const inputLista = document.getElementById('input-lista');
        const outputPowerDuplicate = document.getElementById('output-powerduplicate');
        const outputNomes = document.getElementById('output-nomes');
        const outputNumeros = document.getElementById('output-numeros');
        const btnCriarKanban = document.getElementById('btn-criar-kanban');
        
        const btnCopiarPowerDuplicate = document.getElementById('btn-copiar-powerduplicate');
        const btnCopiarNomes = document.getElementById('btn-copiar-nomes');
        const btnCopiarNumeros = document.getElementById('btn-copiar-numeros');
        
        const errorMessage = document.getElementById('error-message');
        const toggleSwitch = document.getElementById('checkbox');

        // --- ESTADO (ANTIGO) ---
        let jogadoresOrganizados = [];

        // --- LÓGICA PRINCIPAL (NOVA) ---
        
        btnOrganizar.addEventListener('click', handleOrganizeClick);

        async function handleOrganizeClick() {
            const userInput = inputLista.value;

            if (!userInput.trim()) {
                errorMessage.textContent = "Por favor, insira alguns pedidos para organizar.";
                return;
            }

            // UI de Carregamento (estilo antigo)
            loadingIndicator(true);
            errorMessage.textContent = "";
            outputPowerDuplicate.value = "";
            outputNomes.value = "";
            outputNumeros.value = "";

            try {
                // Construir o payload para a API
                const payload = {
                    contents: [{
                        parts: [{ text: userInput }]
                    }],
                    systemInstruction: {
                        parts: [{ text: SYSTEM_PROMPT }]
                    },
                };

                // Chamar a API com retentativa
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Processar a resposta da IA
                const formattedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (formattedText) {
                    const textoLimpo = formattedText.trim();
                    outputPowerDuplicate.value = textoLimpo;
                    
                    // Processa para Corel E salva o resultado
                    const jogadores = processarParaCorel(textoLimpo);
                    jogadoresOrganizados = jogadores; // Salva no estado

                    if (jogadoresOrganizados.length > 0) {
                        btnCriarKanban.disabled = false;
                    }

                } else {
                    throw new Error("A IA não retornou um texto formatado.");
                }

            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                errorMessage.textContent = `Erro: ${error.message}. Tente novamente.`;
            } finally {
                // Limpa UI de Carregamento
                loadingIndicator(false);
            }
        }

        /**
         * Função para fetch com retentativa (NOVO)
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            let lastError;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    lastError = error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Aumenta o delay
                }
            }
            throw lastError;
        }

        /**
         * Função de processamento para Corel (NOVA, baseada na sua)
         * Agora retorna o array de jogadores.
         */
        function processarParaCorel(textoLimpoIA) {
            const linhas = textoLimpoIA.split('\n');
            let jogadores = [];

            linhas.forEach(linha => {
                if (linha.startsWith('[') || linha.trim() === "") return; 
                const partes = linha.split(' ');
                if (partes.length < 3) return; 

                const tamanho = partes[partes.length - 1];
                const numero = partes[partes.length - 2];
                const nome = partes.slice(0, -2).join(' '); 

                jogadores.push({ nome, numero, tamanho });
            });

            const ordemTamanhos = { 'PP': 1, 'P': 2, 'M': 3, 'G': 4, 'GG': 5, 'XG': 6 };
            jogadores.sort((a, b) => (ordemTamanhos[a.tamanho] || 99) - (ordemTamanhos[b.tamanho] || 99));

            let nomesString = '';
            let numerosString = '';
            let tamanhoAtual = null;

            jogadores.forEach(j => {
                if (j.tamanho !== tamanhoAtual) {
                    tamanhoAtual = j.tamanho;
                    const separador = `----------- ${tamanhoAtual} -----------`;
                    if (nomesString !== '') {
                        nomesString += `\n${separador}\n`;
                        numerosString += `\n${separador}\n`;
                    } else {
                        nomesString += `${separador}\n`;
                        numerosString += `${separador}\n`;
                    }
                }
                nomesString += `${j.nome || ''}\n`;
                numerosString += `${j.numero || ''}\n`;
            });

            outputNomes.value = nomesString.trimEnd();
            outputNumeros.value = numerosString.trimEnd();
            
            return jogadores; // Retorna para salvar no estado
        }

        // --- LÓGICA DO KANBAN (ANTIGA) ---
        btnCriarKanban.addEventListener('click', () => {
            if (jogadoresOrganizados.length > 0) {
                // Salva no localStorage para a outra página (index.html) pegar
                localStorage.setItem('novoPedidoData', JSON.stringify(jogadoresOrganizados));
                window.location.href = 'index.html';
            }
        });

        // --- FUNÇÕES DE UI (ANTIGAS + NOVAS) ---

        // Controla o estado de carregamento do botão
        function loadingIndicator(isLoading) {
            if (isLoading) {
                btnOrganizar.disabled = true;
                btnOrganizar.innerText = 'Processando...';
            } else {
                btnOrganizar.disabled = false;
                btnOrganizar.innerText = 'Organizar com IA';
            }
        }
        
        // Botões de Copiar (do seu app antigo)
        btnCopiarPowerDuplicate.addEventListener('click', (e) => copiarParaClipboard('output-powerduplicate', e.target));
        btnCopiarNomes.addEventListener('click', (e) => copiarParaClipboard('output-nomes', e.target));
        btnCopiarNumeros.addEventListener('click', (e) => copiarParaClipboard('output-numeros', e.target));
        
        function copiarParaClipboard(elementId, buttonElement) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            
            try {
                // Tenta a API moderna (melhor)
                navigator.clipboard.writeText(textarea.value).then(() => {
                    const originalText = buttonElement.innerText;
                    buttonElement.innerText = 'Copiado!';
                    setTimeout(() => {
                        buttonElement.innerText = "Copiar";
                    }, 2000);
                }).catch(err => {
                    // Fallback para o método antigo (execCommand)
                    throw new Error('Falha no clipboard.writeText');
                });
            } catch (err) {
                // Fallback (do seu app antigo)
                document.execCommand('copy');
                const originalText = buttonElement.innerText;
                buttonElement.innerText = 'Copiado!';
                setTimeout(() => {
                    buttonElement.innerText = "Copiar";
                }, 2000);
            }
        }

        // Lógica do Dark Mode (do seu app antigo)
        function switchTheme(e) {
            if (e.target.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }
        toggleSwitch.addEventListener('change', switchTheme, false);
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
            toggleSwitch.checked = true;
        }
    });
    </script>
</body>
</html>
