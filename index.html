<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadro Kanban | Gestão de Pedidos</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SortableJS: Biblioteca para arrastar e soltar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Scripts do Firebase - Adicionados para a versão multi-usuário -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        /* O CSS permanece o mesmo da versão anterior */
        :root {
            --cor-fundo: #f4f7fd;
            --cor-coluna-fundo: #e9eef8;
            --cor-cartao-fundo: #ffffff;
            --cor-texto-primaria: #172b4d;
            --cor-texto-secundaria: #5e6c84;
            --cor-sombra: rgba(23, 43, 77, 0.1);
            --cor-borda: #dfe1e6;
            --cor-azul-principal: #0052cc;
            --cor-azul-hover: #005ef9;
            --cor-verde-principal: #00875a00;
            --cor-verde-hover: #006644;
            --espacamento: 16px;
            --raio-borda: 8px;
        }

        body.dark-mode {
            --cor-fundo: #0d1117;
            --cor-coluna-fundo: #161b22;
            --cor-cartao-fundo: #21262d;
            --cor-texto-primaria: #c9d1d9;
            --cor-texto-secundaria: #8b949e;
            --cor-sombra: rgba(0, 0, 0, 0.2);
            --cor-borda: #30363d;
            --cor-azul-principal: #388bfd;
            --cor-azul-hover: #58a6ff;
            --cor-verde-principal: #23863700;
            --cor-verde-hover: #2ea043;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto-primaria); margin: 0; padding: var(--espacamento); overflow-x: auto; transition: background-color 0.3s, color 0.3s; }
        .container-principal { max-width: 100%; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--espacamento); padding: 0 calc(var(--espacamento) / 2); }
        .header-esquerda { display: flex; align-items: center; gap: 20px; }
        h1 { font-size: 1.8rem; margin: 0; }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cor-azul-principal); }
        input:checked + .slider:before { transform: translateX(20px); }
        .btn-adicionar { background-color: var(--cor-azul-principal); color: white; border: none; padding: 10px 16px; font-size: 1rem; font-weight: 500; border-radius: var(--raio-borda); cursor: pointer; transition: background-color 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .btn-adicionar:hover { background-color: var(--cor-azul-hover); }
        .quadro-kanban { display: flex; gap: var(--espacamento); align-items: flex-start; min-height: 80vh; padding-bottom: 60px; }
        .coluna { background-color: var(--cor-coluna-fundo); border-radius: var(--raio-borda); padding: calc(var(--espacamento) / 2); width: 320px; min-width: 320px; flex-shrink: 0; transition: background-color 0.3s; }
        .coluna-header { padding: 8px; margin-bottom: var(--espacamento); display: flex; justify-content: space-between; align-items: center; }
        .coluna-header h2 { font-size: 1.1rem; margin: 0; color: var(--cor-texto-primaria); }
        .contador-cartoes { background-color: var(--cor-borda); color: var(--cor-texto-secundaria); font-size: 0.8rem; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
        .cartoes { min-height: 100px; display: flex; flex-direction: column; gap: var(--espacamento); }
        .cartao { background-color: var(--cor-cartao-fundo); border-radius: var(--raio-borda); padding: var(--espacamento); box-shadow: 0 1px 3px var(--cor-sombra); cursor: grab; border-left: 5px solid transparent; transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.3s; }
        .cartao:hover { box-shadow: 0 4px 8px var(--cor-sombra); }
        .cartao-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .titulo-cartao { font-weight: 600; font-size: 1.05rem; flex-grow: 1; }
        .cartao-actions { display: flex; gap: 4px; }
        .btn-card-action { background: none; border: none; cursor: pointer; opacity: 0.5; transition: opacity 0.2s ease; color: var(--cor-texto-secundaria); padding: 2px; }
        .btn-card-action:hover { opacity: 1; }
        .descricao-cartao { font-size: 0.9rem; color: var(--cor-texto-secundaria); line-height: 1.4; margin-bottom: 12px; }
        .arte-referencia { max-width: 100%; border-radius: 4px; margin-bottom: 12px; }
        .lista-jogadores { font-size: 0.9rem; max-height: 150px; overflow-y: auto; padding-right: 10px; margin-bottom: 12px; }
        .jogador-item { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; padding: 4px; border-radius: 4px; }
        .jogador-item:nth-child(odd) { background-color: var(--cor-fundo); }
        .jogador-nome { font-weight: 500; }
        .jogador-tamanho { font-weight: 500; background-color: var(--cor-coluna-fundo); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; justify-self: center; }
        .jogador-numero { font-weight: 600; background-color: var(--cor-borda); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; justify-self: end; }
        .detalhe-calcao { background-color: #d1f7c4; color: #2a7a13; font-weight: 600 !important; }
        body.dark-mode .detalhe-calcao { background-color: #234c1b; color: #a6f699; }
        .cartao-detalhes { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; font-size: 0.85rem; }
        .detalhe-item { background-color: var(--cor-fundo); padding: 4px 8px; border-radius: 4px; }
        .cartao-footer { display: flex; justify-content: space-between; align-items: center; }
        .data-entrega { font-size: 0.8rem; background-color: var(--cor-fundo); padding: 4px 8px; border-radius: 4px; }
        .sortable-ghost { opacity: 0.4; background: #cdd5e3; }
        .sortable-chosen { cursor: grabbing; box-shadow: 0 8px 16px var(--cor-sombra); transform: rotate(3deg); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-conteudo { background-color: var(--cor-cartao-fundo); padding: 24px; border-radius: var(--raio-borda); width: 90%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-conteudo h2 { margin-top: 0; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--cor-borda); border-radius: var(--raio-borda); font-family: 'Inter', sans-serif; font-size: 1rem; box-sizing: border-box; background-color: var(--cor-fundo); color: var(--cor-texto-primaria); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; padding: 10px; background-color: var(--cor-fundo); border-radius: var(--raio-borda); }
        .form-group-checkbox input[type="checkbox"] { width: auto; margin: 0; height: 18px; width: 18px; }
        .form-group-checkbox label { margin: 0; font-weight: 500; }
        #jogadores-container { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; background-color: var(--cor-fundo); padding: 10px; border-radius: var(--raio-borda); }
        .jogador-input-group { display: grid; grid-template-columns: 20px 1fr 80px 70px; gap: 10px; align-items: center; }
        .jogador-input-group label { text-align: right; font-size: 0.9rem; color: var(--cor-texto-secundaria); }
        .jogador-input-group input, .jogador-input-group select { padding: 8px; }
        #arte-preview { max-width: 150px; max-height: 150px; margin-top: 10px; border-radius: 4px; display: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .btn-modal { padding: 10px 20px; border-radius: var(--raio-borda); border: none; cursor: pointer; font-weight: 500; }
        .btn-cancelar { background-color: var(--cor-coluna-fundo); color: var(--cor-texto-primaria); }
        .btn-salvar { background-color: var(--cor-azul-principal); color: white; }
        .footer-actions { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--cor-fundo); box-shadow: 0 -2px 10px var(--cor-sombra); padding: var(--espacamento); display: flex; justify-content: flex-start; gap: 12px; box-sizing: border-box; z-index: 500; }
        .btn-footer { background-color: var(--cor-verde-principal); color: white; border: none; padding: 10px 16px; font-size: 0.9rem; font-weight: 500; border-radius: var(--raio-borda); cursor: pointer; transition: background-color 0.2s ease; display: flex; align-items: center; gap: 8px; }
        .btn-footer:hover { background-color: var(--cor-verde-hover); }
        .btn-footer.importar { background-color: var(--cor-texto-secundaria); }
        .btn-footer.importar:hover { background-color: var(--cor-texto-primaria); }

        /* Estilos para o novo modal de exportação */
        .export-modal-group { margin-bottom: 20px; }
        .export-modal-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .export-modal-group textarea { width: 100%; height: 150px; resize: vertical; padding: 8px; font-family: monospace; font-size: 0.9rem; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
        .export-modal-actions { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="container-principal">
        <header>
     <div class="header-esquerda">
        <h1>Meu Kanban de Pedidos</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
    </div>
    <nav>
        <a href="organizador.html" class="nav-link" style="background-color: var(--cor-verde-principal); color: white;">Ir para o Organizador</a>
    </nav>
    <button class="btn-adicionar" id="btn-novo-pedido">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Novo Pedido
    </button>
</header>

        <div class="quadro-kanban" id="quadro-kanban"></div>
    </div>

    <!-- Modal para Adicionar/Editar Pedido -->
    <div class="modal-overlay" id="modal-pedido">
        <div class="modal-conteudo">
            <h2 id="modal-titulo">Adicionar Novo Pedido</h2>
            <form id="form-pedido">
                <input type="hidden" id="cardId" name="cardId">
                <input type="hidden" id="columnId" name="columnId">
                <div class="form-group">
                    <label for="titulo">Título do Pedido (Ex: Cliente XPTO)</label>
                    <input type="text" id="titulo" name="titulo" required>
                </div>
                <div class="form-group">
                    <label for="descricao">Descrição (Ex: Estampa Leão, gola V)</label>
                    <textarea id="descricao" name="descricao" required></textarea>
                </div>
                <div class="form-group">
                    <label for="quantidade">Qtd. Camisas</label>
                    <input type="number" id="quantidade" name="quantidade" min="0">
                </div>
                <div class="form-group">
                    <label>Nomes, Tamanhos e Números (Individual)</label>
                    <div id="jogadores-container">
                        <small>Preencha a quantidade para gerar os campos.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="arte">Anexar arte/referência (opcional)</label>
                    <input type="file" id="arte" name="arte" accept="image/*">
                    <img id="arte-preview" src="" alt="Preview da arte">
                    <input type="hidden" id="arte-base64" name="arte-base64">
                </div>
                <div class="form-group">
                    <label for="data-entrega">Data de Entrega</label>
                    <input type="date" id="data-entrega" name="data-entrega">
                </div>
                <div class="form-group form-group-checkbox">
                    <input type="checkbox" id="com-calcao" name="com-calcao">
                    <label for="com-calcao">Pedido inclui calção (fardamento completo)?</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancelar" id="btn-cancelar-modal">Cancelar</button>
                    <button type="submit" class="btn-modal btn-salvar">Salvar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Exportar Dados para o Corel -->
    <div class="modal-overlay" id="modal-export-corel">
        <div class="modal-conteudo">
            <h2>Exportar para CorelDRAW</h2>
            <p>Copie e cole estas listas no Power Duplicate.</p>
            <div class="export-modal-group">
                <div class="export-modal-actions">
                    <label for="corel-nomes">Lista de Nomes (Ordenado por Tamanho)</label>
                    <button class="btn-modal btn-salvar" id="btn-copiar-nomes">Copiar Nomes</button>
                </div>
                <textarea id="corel-nomes" readonly></textarea>
            </div>
            <div class="export-modal-group">
                <div class="export-modal-actions">
                     <label for="corel-numeros">Lista de Números (Ordenado por Tamanho)</label>
                    <button class="btn-modal btn-salvar" id="btn-copiar-numeros">Copiar Números</button>
                </div>
                <textarea id="corel-numeros" readonly></textarea>
            </div>
             <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancelar" id="btn-fechar-export-modal">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // COLE A CONFIGURAÇÃO DO SEU FIREBASE AQUI
        // =================================================================
        const firebaseConfig = {
             apiKey: "AIzaSyAtNP_9aD3xv1BZZGjFYfSBH7-8Ui085Lo",
  authDomain: "meu-kanban-pedidos.firebaseapp.com",
  projectId: "meu-kanban-pedidos",
  storageBucket: "meu-kanban-pedidos.firebasestorage.app",
  messagingSenderId: "781917748477",
  appId: "1:781917748477:web:9b2c1effa1bd54b4321294",
  measurementId: "G-X2CWKJWZ2H"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const quadroKanban = document.getElementById('quadro-kanban');
            
            // ---- FUNÇÃO PRINCIPAL: CARREGAR QUADRO EM TEMPO REAL ----
            function carregarQuadroEmTempoReal() {
                db.collection("kanban-board").orderBy("order").onSnapshot(snapshot => {
                    quadroKanban.innerHTML = ''; 
                    if (snapshot.empty) {
                        console.log("Banco de dados vazio. Criando colunas iniciais...");
                        criarColunasIniciais();
                        return;
                    }

                    snapshot.forEach(doc => {
                        const colunaData = doc.data();
                        colunaData.id = doc.id;
                        const elementoColuna = criarColuna(colunaData);
                        const containerCartoes = elementoColuna.querySelector('.cartoes');
                        if (colunaData.cartoes) {
                           colunaData.cartoes.sort((a, b) => a.order - b.order).forEach(cartaoData => {
                                const elementoCartao = criarCartao(cartaoData, colunaData.id);
                                containerCartoes.appendChild(elementoCartao);
                            });
                        }
                        quadroKanban.appendChild(elementoColuna);
                    });
                    
                    atualizarContadores();
                    inicializarSortable();
                });
            }

            // ---- FUNÇÕES DE MANIPULAÇÃO DE DADOS (CRUD com Firestore) ----
            async function salvarNovoCartao(dadosCartao) { const colunaRef = db.collection("kanban-board").doc('coluna-1'); await colunaRef.update({ cartoes: firebase.firestore.FieldValue.arrayUnion(dadosCartao) }); }
            async function atualizarCartaoExistente(dadosCartao, columnId) { const colunaRef = db.collection("kanban-board").doc(columnId); const doc = await colunaRef.get(); if (doc.exists) { const colunaData = doc.data(); const cartoesAtualizados = colunaData.cartoes.map(c => c.id === dadosCartao.id ? dadosCartao : c ); await colunaRef.update({ cartoes: cartoesAtualizados }); } }
            async function excluirCartao(cardId, columnId) { const colunaRef = db.collection("kanban-board").doc(columnId); const doc = await colunaRef.get(); if (doc.exists) { const colunaData = doc.data(); const cartoesAtualizados = colunaData.cartoes.filter(c => c.id !== cardId); await colunaRef.update({ cartoes: cartoesAtualizados }); } }
            async function salvarOrdemNoFirestore() { const batch = db.batch(); document.querySelectorAll('.coluna').forEach((colunaEl, index) => { const columnId = colunaEl.id; const cartoesOrdenados = []; colunaEl.querySelectorAll('.cartao').forEach((cartaoEl, cardIndex) => { const dados = JSON.parse(cartaoEl.dataset.cardData); dados.order = cardIndex; cartoesOrdenados.push(dados); }); const colunaRef = db.collection("kanban-board").doc(columnId); batch.update(colunaRef, { cartoes: cartoesOrdenados, order: index }); }); await batch.commit(); }

            // ---- LÓGICA DE CRIAÇÃO DOS ELEMENTOS HTML ----
             function criarCartao(cartaoData, columnId) {
                const { id, titulo, descricao, data, quantidade, jogadores, arte, comCalcao } = cartaoData;
                const elementoCartao = document.createElement('div');
                elementoCartao.id = id;
                elementoCartao.className = 'cartao';
                elementoCartao.draggable = true;
                elementoCartao.dataset.cardData = JSON.stringify(cartaoData);
                elementoCartao.dataset.columnId = columnId;

                const dataFormatada = data ? new Date(data + 'T00:00:00').toLocaleDateString('pt-BR') : '';
                const corBorda = obterCorBordaPorData(data);
                
                let detalhesHTML = '';
                if (quantidade) detalhesHTML += `<div class="detalhe-item"><strong>Qtd:</strong> ${quantidade}</div>`;
                if (comCalcao) detalhesHTML += `<div class="detalhe-item detalhe-calcao"><strong>+ Calção</strong></div>`;
                
                let jogadoresHTML = '';
                if (jogadores && jogadores.length > 0) {
                    jogadoresHTML += '<div class="lista-jogadores">';
                    jogadores.forEach(j => {
                        jogadoresHTML += `<div class="jogador-item"><span class="jogador-nome">${j.nome || '-'}</span><span class="jogador-tamanho">${j.tamanho || '?'}</span><span class="jogador-numero">${j.numero || '-'}</span></div>`;
                    });
                    jogadoresHTML += '</div>';
                }

                let arteHTML = '';
                if (arte) {
                    arteHTML = `<img src="${arte}" class="arte-referencia" alt="Arte de referência">`;
                }

                elementoCartao.innerHTML = `
                    <div class="cartao-header">
                        <span class="titulo-cartao">${titulo}</span>
                        <div class="cartao-actions">
                            <button class="btn-card-action btn-export-corel" title="Exportar para Corel">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            <button class="btn-card-action btn-editar" title="Editar Pedido"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                            <button class="btn-card-action btn-excluir" title="Excluir Pedido"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                    </div>
                    ${arteHTML}
                    <div class="descricao-cartao">${descricao}</div>
                    ${jogadoresHTML}
                    <div class="cartao-footer">
                        <div class="cartao-detalhes">${detalhesHTML}</div>
                        <span class="data-entrega">${dataFormatada ? 'Entrega: ' + dataFormatada : ''}</span>
                    </div>
                `;
                elementoCartao.style.borderLeftColor = corBorda;

                elementoCartao.querySelector('.btn-excluir').addEventListener('click', () => { if (confirm(`Tem certeza que deseja excluir o pedido "${titulo}"?`)) { excluirCartao(id, columnId); } });
                elementoCartao.querySelector('.btn-editar').addEventListener('click', () => abrirModalParaEditar(id, columnId));
                elementoCartao.querySelector('.btn-export-corel').addEventListener('click', () => abrirModalExportCorel(id));
                return elementoCartao;
            }

            function criarColuna(colunaData) { const elementoColuna = document.createElement('div'); elementoColuna.id = colunaData.id; elementoColuna.className = 'coluna'; elementoColuna.innerHTML = ` <div class="coluna-header"> <h2>${colunaData.titulo}</h2> <span class="contador-cartoes">0</span> </div> <div class="cartoes"></div> `; return elementoColuna; }

            // ---- LÓGICA DO MODAL ----
            const modal = document.getElementById('modal-pedido');
            const formPedido = document.getElementById('form-pedido');
            formPedido.addEventListener('submit', async (e) => {
                e.preventDefault();
                const jogadores = [];
                const qtd = parseInt(document.getElementById('quantidade').value, 10) || 0;
                for (let i = 0; i < qtd; i++) {
                    jogadores.push({ 
                        nome: document.getElementById(`jogador-nome-${i}`).value, 
                        numero: document.getElementById(`jogador-numero-${i}`).value,
                        tamanho: document.getElementById(`jogador-tamanho-${i}`).value
                    });
                }
                const dadosCartao = {
                    id: document.getElementById('cardId').value || `card-${Date.now()}`,
                    titulo: e.target.titulo.value.trim(),
                    descricao: e.target.descricao.value.trim(),
                    data: e.target['data-entrega'].value,
                    quantidade: e.target.quantidade.value,
                    jogadores: jogadores,
                    arte: document.getElementById('arte-base64').value,
                    comCalcao: e.target['com-calcao'].checked,
                    order: 999 
                };
                if (dadosCartao.titulo && dadosCartao.descricao) {
                    if (document.getElementById('cardId').value) {
                        const columnId = document.getElementById('columnId').value;
                        await atualizarCartaoExistente(dadosCartao, columnId);
                    } else {
                        await salvarNovoCartao(dadosCartao);
                    }
                    modal.style.display = 'none';
                }
            });
            function abrirModalParaEditar(cardId, columnId) { const elementoCartao = document.getElementById(cardId); if (!elementoCartao) return; const dadosCartao = JSON.parse(elementoCartao.dataset.cardData); formPedido.reset(); document.getElementById('modal-titulo').textContent = 'Editar Pedido'; document.getElementById('cardId').value = dadosCartao.id; document.getElementById('columnId').value = columnId; document.getElementById('titulo').value = dadosCartao.titulo; document.getElementById('descricao').value = dadosCartao.descricao; document.getElementById('data-entrega').value = dadosCartao.data; document.getElementById('quantidade').value = dadosCartao.quantidade || 0; document.getElementById('com-calcao').checked = dadosCartao.comCalcao || false; gerarCamposJogadores(dadosCartao.quantidade || 0, dadosCartao.jogadores); if (dadosCartao.arte) { document.getElementById('arte-preview').src = dadosCartao.arte; document.getElementById('arte-preview').style.display = 'block'; document.getElementById('arte-base64').value = dadosCartao.arte; } else { document.getElementById('arte-preview').style.display = 'none'; document.getElementById('arte-base64').value = ''; } modal.style.display = 'flex'; }
            function abrirModalParaNovo() { formPedido.reset(); document.getElementById('cardId').value = ''; document.getElementById('columnId').value = 'coluna-1'; document.getElementById('modal-titulo').textContent = 'Adicionar Novo Pedido'; document.getElementById('arte-preview').style.display = 'none'; document.getElementById('arte-preview').src = ''; document.getElementById('arte-base64').value = ''; gerarCamposJogadores(0); modal.style.display = 'flex'; }
            function gerarCamposJogadores(qtd, jogadores = []) {
                const container = document.getElementById('jogadores-container');
                container.innerHTML = '';
                if (qtd === 0) { container.innerHTML = '<small>Preencha a quantidade para gerar os campos.</small>'; return; }
                for (let i = 0; i < qtd; i++) {
                    const jogador = jogadores[i] || { tamanho: 'M' }; // Padrão 'M' para novos campos
                    const div = document.createElement('div');
                    div.className = 'jogador-input-group';
                    const tamanhosOptions = ['PP', 'P', 'M', 'G', 'GG', 'XG'].map(t => `<option value="${t}" ${t === jogador.tamanho ? 'selected' : ''}>${t}</option>`).join('');
                    div.innerHTML = `
                        <label for="jogador-nome-${i}">${i + 1}</label>
                        <input type="text" id="jogador-nome-${i}" placeholder="Nome" value="${jogador.nome || ''}">
                        <select id="jogador-tamanho-${i}">${tamanhosOptions}</select>
                        <input type="text" id="jogador-numero-${i}" placeholder="Nº" value="${jogador.numero || ''}">`;
                    container.appendChild(div);
                }
            }

            // ---- LÓGICA DO MODAL DE EXPORTAÇÃO ----
            const modalExport = document.getElementById('modal-export-corel');
            const corelNomes = document.getElementById('corel-nomes');
            const corelNumeros = document.getElementById('corel-numeros');

            function abrirModalExportCorel(cardId) {
                const elementoCartao = document.getElementById(cardId);
                if (!elementoCartao) return;
                const dadosCartao = JSON.parse(elementoCartao.dataset.cardData);
                const jogadores = dadosCartao.jogadores || [];

                // 1. Ordenar por tamanho
                const ordemTamanhos = { 'PP': 1, 'P': 2, 'M': 3, 'G': 4, 'GG': 5, 'XG': 6 };
                jogadores.sort((a, b) => (ordemTamanhos[a.tamanho] || 99) - (ordemTamanhos[b.tamanho] || 99));

                // 2. Gerar as strings agrupadas (LÓGICA CORRIGIDA)
                let nomesString = '';
                let numerosString = '';
                let tamanhoAtual = null;

                jogadores.forEach(j => {
                    if (j.tamanho !== tamanhoAtual) {
                        tamanhoAtual = j.tamanho;
                        const separador = `----------- ${tamanhoAtual} -----------`;
                        if (nomesString !== '') { // Adiciona um espaço antes do novo grupo
                             nomesString += `\n${separador}\n`;
                             numerosString += `\n${separador}\n`;
                        } else { // Para o primeiro grupo (PP), não adiciona o espaço antes
                             nomesString += `${separador}\n`;
                             numerosString += `${separador}\n`;
                        }
                    }
                    nomesString += `${j.nome || ''}\n`;
                    numerosString += `${j.numero || ''}\n`;
                });

                corelNomes.value = nomesString.trimEnd(); // Usar trimEnd para não remover espaços no início
                corelNumeros.value = numerosString.trimEnd();
                modalExport.style.display = 'flex';
            }

            document.getElementById('btn-copiar-nomes').addEventListener('click', () => copiarParaClipboard('corel-nomes', 'Nomes'));
            document.getElementById('btn-copiar-numeros').addEventListener('click', () => copiarParaClipboard('corel-numeros', 'Números'));
            document.getElementById('btn-fechar-export-modal').addEventListener('click', () => modalExport.style.display = 'none');
            modalExport.addEventListener('click', (e) => { if (e.target === modalExport) modalExport.style.display = 'none'; });

            function copiarParaClipboard(elementId, tipo) {
                const textarea = document.getElementById(elementId);
                textarea.select();
                document.execCommand('copy');
                alert(`${tipo} copiados para a área de transferência!`);
            }


            // ---- FUNÇÕES AUXILIARES E EVENT LISTENERS ----
            function inicializarSortable() { const listasCartoes = document.querySelectorAll('.cartoes'); listasCartoes.forEach(lista => { new Sortable(lista, { group: 'kanban', animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', onEnd: salvarOrdemNoFirestore }); }); }
            function atualizarContadores() { document.querySelectorAll('.coluna').forEach(coluna => { const contador = coluna.querySelector('.contador-cartoes'); const numCartoes = coluna.querySelectorAll('.cartao').length; contador.textContent = numCartoes; }); }
            function obterCorBordaPorData(data) { if (!data) return 'transparent'; const hoje = new Date(); hoje.setHours(0,0,0,0); const dataEntrega = new Date(data + 'T00:00:00'); const diffDias = Math.ceil((dataEntrega - hoje) / (1000 * 60 * 60 * 24)); if (diffDias < 0) return '#d93f3f'; if (diffDias <= 3) return '#e89c33'; return '#36b37e'; }
            const toggleSwitch = document.getElementById('checkbox'); function switchTheme(e) { if (e.target.checked) { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); } else { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); } }
            toggleSwitch.addEventListener('change', switchTheme, false); const currentTheme = localStorage.getItem('theme'); if (currentTheme === 'dark') { document.body.classList.add('dark-mode'); toggleSwitch.checked = true; }
            document.getElementById('btn-novo-pedido').addEventListener('click', abrirModalParaNovo);
            document.getElementById('btn-cancelar-modal').addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            document.getElementById('quantidade').addEventListener('input', () => gerarCamposJogadores(parseInt(document.getElementById('quantidade').value, 10) || 0));
            document.getElementById('arte').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('arte-preview').src = event.target.result; document.getElementById('arte-preview').style.display = 'block'; document.getElementById('arte-base64').value = event.target.result; }; reader.readAsDataURL(file); });
            async function criarColunasIniciais() { const colunas = [ { id: 'coluna-1', titulo: 'Novos Pedidos', order: 0, cartoes: [] }, { id: 'coluna-2', titulo: 'Arte / Design', order: 1, cartoes: [] }, { id: 'coluna-3', titulo: 'Em Produção', order: 2, cartoes: [] }, { id: 'coluna-4', titulo: 'Pronto p/ Entrega', order: 3, cartoes: [] }, { id: 'coluna-5', titulo: 'Entregue / Faturado', order: 4, cartoes: [] } ]; const batch = db.batch(); colunas.forEach(col => { const docRef = db.collection("kanban-board").doc(col.id); batch.set(docRef, col); }); await batch.commit(); }
            carregarQuadroEmTempoReal();
        });
    </script>
</body>
</html>



